{% macro render_comment(comment, post_id, current_user_id, is_reply=False) %}
<div class="comment-item {% if is_reply %}reply-item{% endif %}" id="comment-{{ comment.id }}" data-comment-id="{{ comment.id }}">
    <div class="comment-header">
        <span class="comment-author">{{ comment.user.username }}</span>
        <span class="comment-time">{{ comment.created_at.strftime('%b %d, %Y') }}</span>
    </div>
    <div class="comment-content">{{ comment.content }}</div>
    <div class="comment-actions">
        {% if comment.reply_count > 0 %}
        <button class="comment-replies-toggle" data-comment-id="{{ comment.id }}">
            {{ comment.reply_count }} {{ 'reply' if comment.reply_count == 1 else 'replies' }}
        </button>
        {% endif %}
        <button class="comment-reply-btn" data-comment-id="{{ comment.id }}" data-post-id="{{ post_id }}">Reply</button>
        {% if comment.user_id == current_user_id %}
        <button class="comment-delete-btn" hx-delete="/api/comment/{{ comment.id }}" hx-target="#comment-{{ comment.id }}" hx-swap="outerHTML" hx-confirm="Delete?">Delete</button>
        {% endif %}
    </div>

    <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display: none;">
        <form class="reply-form" hx-post="/api/comment/{{ post_id }}" hx-target="#replies-{{ comment.id }}" hx-swap="beforeend">
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            <input type="text" name="comment" placeholder="Write a reply..." required>
            <button type="submit">Reply</button>
            <button type="button" class="cancel-reply" data-comment-id="{{ comment.id }}">Cancel</button>
        </form>
    </div>

    <div class="comment-replies" id="replies-{{ comment.id }}" style="{% if comment.reply_count > 0 %}display: none;{% else %}display: none;{% endif %}">
        {% for reply in comment.replies %}
            {{ render_comment(reply, post_id, current_user_id, is_reply=True) }}
        {% endfor %}
    </div>
</div>
{% endmacro %}

<div class="comments-list" id="comments-list-{{ post_id }}">
    {% if comments %}
        {% for comment in comments %}
            {{ render_comment(comment, post_id, current_user_id) }}
        {% endfor %}
    {% else %}
        <div class="no-comments">No comments yet. Be the first to comment!</div>
    {% endif %}
</div>
