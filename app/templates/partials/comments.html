{% macro render_comment(comment, post_id, current_user_id, is_reply=False) %}
<div class="{% if is_reply %}ml-6 pl-4 border-l-2 border-gray-200{% endif %} bg-white rounded-xl shadow-md p-4 mb-3 hover:shadow-xl transition-all duration-300 animate-fade-in"
     id="comment-{{ comment.id }}"
     data-comment-id="{{ comment.id }}">

    <!-- Comment Header -->
    <div class="flex justify-between items-center mb-2">
        <span class="font-semibold text-gray-800 text-sm">{{ comment.user.username }}</span>
        <span class="text-xs text-gray-500">{{ comment.created_at.strftime('%b %d, %Y') }}</span>
    </div>

    <!-- Comment Content -->
    <div class="text-gray-700 text-sm mb-3 break-words leading-relaxed">{{ comment.content }}</div>

    <!-- Comment Actions -->
    <div class="flex gap-3 items-center">
        {% if comment.reply_count > 0 %}
        <button class="text-xs font-semibold text-primary hover:text-secondary transition-colors duration-200 comment-replies-toggle"
                data-comment-id="{{ comment.id }}">
            {{ comment.reply_count }} {{ 'reply' if comment.reply_count == 1 else 'replies' }}
        </button>
        {% endif %}
        <button class="text-xs text-gray-600 hover:text-primary transition-colors duration-200 comment-reply-btn"
                data-comment-id="{{ comment.id }}"
                data-post-id="{{ post_id }}">
            Reply
        </button>
        {% if comment.user_id == current_user_id %}
        <button class="text-xs text-gray-600 hover:text-red-500 hover:animate-wiggle transition-all duration-200 comment-delete-btn"
                hx-delete="/api/comment/{{ comment.id }}"
                hx-target="#comment-{{ comment.id }}"
                hx-swap="outerHTML"
                hx-confirm="Delete?">
            Delete
        </button>
        {% endif %}
    </div>

    <!-- Reply Form Container -->
    <div class="hidden mt-3 animate-slide-up reply-form-container" id="reply-form-{{ comment.id }}">
        <form class="flex gap-2 p-3 bg-gray-50 rounded-lg reply-form"
              hx-post="/api/comment/{{ post_id }}"
              hx-target="#replies-{{ comment.id }}"
              hx-swap="beforeend">
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            <input type="text"
                   name="comment"
                   placeholder="Write a reply..."
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-full text-sm focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all duration-300"
                   required>
            <button type="submit"
                    class="px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white rounded-full text-sm font-medium hover:scale-105 hover:shadow-lg active:scale-95 transition-all duration-300">
                Reply
            </button>
            <button type="button"
                    class="px-4 py-2 bg-gray-400 text-white rounded-full text-sm font-medium hover:bg-gray-500 active:scale-95 transition-all duration-200 cancel-reply"
                    data-comment-id="{{ comment.id }}">
                Cancel
            </button>
        </form>
    </div>

    <!-- Nested Replies Container -->
    <div class="mt-3 hidden comment-replies-container"
         id="replies-container-{{ comment.id }}">
        <div class="flex flex-col gap-2" id="replies-{{ comment.id }}">
            {% for reply in comment.replies %}
                {{ render_comment(reply, post_id, current_user_id, is_reply=True) }}
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

<!-- Main Comments List -->
<div class="flex flex-col gap-3" id="comments-list-{{ post_id }}">
    {% if comments %}
        {% for comment in comments %}
            {{ render_comment(comment, post_id, current_user_id) }}
        {% endfor %}
    {% else %}
        <div class="text-center py-8 text-gray-500 text-sm italic">
            No comments yet. Be the first to comment!
        </div>
    {% endif %}
</div>
